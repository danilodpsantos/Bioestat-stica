---
title: "Trabalho 1 Modelos Lineares"
author: "Danilo de Paula Santos"
date: "10/18/2019"
output:
  html_document:
    df_print: paged
---

As questões a seguir referem-se ao estudo de Gross et al (1999) sobre a relação entre financiamento pelo National Institutes of Health e carga de 29 doenças. Os dados da Tabela 1 desde estudo estão no arquivo 3.ex.Funding.sav. Os nomes das variáveis e definições neste arquivo são:

!["variaveis"](C:/Users/Gabriela/Documents/Bioestatistica_PPGEPI/Modelos_lineares/Trabalho_1/variaveis_gross.PNG)


```{r preparing_R}

# install.packages("haven")
# install.packages("ggplot2")
#install.packages("RColorBrewer")
#install.packages("ellipse")

library("haven")
library("ggplot2")
library("compareGroups")
library("tidyverse")
library("RColorBrewer")
library("ellipse")

dados <- read_spss(file = "3.ex.Funding.sav")

```
# DESCRIÇÃO GERAL DO BANCO

```{r agrupando_diseases}
# transformando disease e factor
dados$disease <- factor(dados$disease)


# Gerando grupos de doenças

dados$disease_group <- ifelse(dados$disease ==  "Breast Cancer"     |
                              dados$disease ==  "Cervical cancer"   |
                              dados$disease ==  "Colorectal cancer" |
                              dados$disease ==  "Lung cancer"     |
                              dados$disease ==  "Ovarian cancer"  |
                              dados$disease ==  "Prostate cancer" |
                              dados$disease ==  "Uterine cancer", "Cancer", 
                              ifelse( dados$disease == "Cirrhosis" |
                                      dados$disease == "Chronic obst. pulmonary d" |
                                      dados$disease == "Ischemic heart disease" |
                                      dados$disease == "Stroke"  |
                                      dados$disease ==  "Diabetes mellitus"|
                                      dados$disease ==   "Asthma" | 
                                      dados$disease == "Peptic ulcer"|
                                      dados$disease == "Alcohol abuse","Non-communicable diseases",
                                      ifelse(dados$disease == "Dental and oral disorders","Other non-communicable diseases",
                                      ifelse(dados$disease == "Dementia" |
                                             dados$disease == "Depression"  |
                                             dados$disease == "Epilepsy"   |
                                             dados$disease == "Parkinson's disease" | 
                                             dados$disease ==  "Multiple sclerosis" |
                                             dados$disease == "Schizophrenia" , "Mental and neurological disorders", 
                                             ifelse(dados$disease == "Tuberculosis"|
                                                    dados$disease == "Sexually transmitted dise"|
                                                    dados$disease == "Pneumonia" |
                                                    dados$disease == "Otitis media"|
                                                    dados$disease == "Perinatal conditions", "Communicable and neonatal diseases",
                                                           ifelse(dados$disease == "Injuries", "Injuries", 
                                                                  ifelse(dados$disease == "AIDS", "AIDS", NA)))))))


```

```{r variaveis_grupos}

dados_grupo <- dados%>%
  group_by(disease_group) %>%
  summarise(dollars_group = sum(dollars, na.rm = TRUE),
            incid_group = sum(incid, na.rm = TRUE),
            preval_group = sum(preval, na.rm = TRUE),
            hospdays_group = sum(hospdays, na.rm = TRUE),
            mort_group = sum(mort, na.rm = TRUE),
            yrslost_group = sum(yrslost, na.rm = TRUE),
            disabil_group = sum(disabil, na.rm = TRUE))

dados <- merge(dados, dados_grupo)

```

```{r descritiva_ex_1 }

compare_doencas <- compareGroups(disease_group ~ dollars_group + incid_group + preval_group + hospdays_group + mort_group + yrslost_group + disabil_group,
                                 data = dados,
                                 max.ylev = 29)

table_descr <- createTable(compare_doencas, show.p.overall = FALSE, show.ratio = TRUE, show.n = FALSE, type = 3)


table_descr
```

1. 

__a) Explore a relação entre dollars e as outras variáveis independentes (exceto disease e id).__ 

```{r correlation_var_outcome}

#Crio um objeto com as variáveis que quero correlacionar
my_data <- dados[,c("dollars", "incid", "preval", "mort", "hospdays", "yrslost", "disabil")]

#aplico a função de correlação, ignorando os valores missing (complete.obs)
cor_matrix <- cor(my_data, use = "complete.obs")

#arredondo para duas casas decimais
round(cor_matrix,2)
```

```{r correlation_plot}

#Não sei se ficou bom
pairs( ~ dollars+incid+preval+ mort+ hospdays+ yrslost+ disabil, data = dados)
```


```{r scat_function}

#Função que fixa o banco como dados e o y como dólares para criar um scatterplot


dollar_plot <- function(data, x_var, y_var ){
  
  

  ggplot(data = data,
         aes(x = x_var,
             y = y_var)) +
    geom_point()
  
  
}


```


```{r lm_dol_incid}

lm_dol_incid <- lm(formula = dollars ~ incid,
                    data = dados)

summary(lm_dol_incid)


```

```{r scat_dol_incid}




scat_dol_incid <- ggplot(dados, aes(x = incid, y = dollars)) +
                                 geom_point() +
                                 geom_smooth(method = "lm") +
                                 scale_x_continuous("Incidence per 1000") +
                                 scale_y_continuous("thousands of NIH research dollars") +
                                 theme_minimal() +
  labs(title = paste("Adj R2 = ",signif(summary(lm_dol_incid)$adj.r.squared, 5),
                         "Intercept =",signif(lm_dol_incid$coef[[1]],5 ),
                         " Slope =",signif(lm_dol_incid$coef[[2]], 5),
                         " p =",signif(summary(lm_dol_incid)$coef[2,4], 5)))

scat_dol_incid
```


```{r lm_dol_preval}

lm_dol_preval <- lm(formula = dollars ~ preval,
                    data = dados)

summary(lm_dol_preval)


```

```{r scat_dol_preval}

scat_dol_preval <- ggplot(dados, aes(x = incid, y = dollars)) +
                                 geom_point() +
                                 geom_smooth(method = "lm") +
                                 scale_x_continuous("Incidence per 1000") +
                                 scale_y_continuous("thousands of NIH research dollars") +
                                 theme_minimal() +
  labs(title = paste("Adj R2 = ",signif(summary(lm_dol_preval)$adj.r.squared, 5),
                         "Intercept =",signif(lm_dol_preval$coef[[1]],5 ),
                         " Slope =",signif(lm_dol_preval$coef[[2]], 5),
                         " p =",signif(summary(lm_dol_preval)$coef[2,4], 5)))

scat_dol_preval


```

```{r lm_dol_mort}

lm_dol_mort <- lm(formula = dollars ~ mort,
                    data = dados)

summary(lm_dol_mort)


```

```{r scat_dol_mort}

scat_dol_mort <- ggplot(dados, aes(x = mort, y = dollars)) +
                                 geom_point() +
                                 geom_smooth(method = "lm") +
                                 scale_x_continuous("Mortality per 1000") +
                                 scale_y_continuous("thousands of NIH research dollars") +
                                 theme_minimal() +
  labs(title = paste("Adj R2 = ",signif(summary(lm_dol_mort)$adj.r.squared, 5),
                         "Intercept =",signif(lm_dol_mort$coef[[1]],5 ),
                         " Slope =",signif(lm_dol_mort$coef[[2]], 5),
                         " p =",signif(summary(lm_dol_mort)$coef[2,4], 5)))

scat_dol_mort


```

```{r lm_dol_hospdays}

lm_dol_hospdays <- lm(formula = dollars ~ hospdays,
                    data = dados)

summary(lm_dol_hospdays)


```

```{r scat_dol_hospdays}

scat_dol_hospdays <- ggplot(dados, aes(x = hospdays, y = dollars)) +
                                 geom_point() +
                                 geom_smooth(method = "lm") +
                                 scale_x_continuous("Thousands of hospital days") +
                                 scale_y_continuous("thousands of NIH research dollars") +
                                 theme_minimal() +
  labs(title = paste("Adj R2 = ",signif(summary(lm_dol_hospdays)$adj.r.squared, 5),
                         "Intercept =",signif(lm_dol_hospdays$coef[[1]],5 ),
                         " Slope =",signif(lm_dol_hospdays$coef[[2]], 5),
                         " p =",signif(summary(lm_dol_hospdays)$coef[2,4], 5)))

scat_dol_hospdays


```
```{r lm_dol_yrslost}

lm_dol_yrslost <- lm(formula = dollars ~ yrslost,
                    data = dados)

summary(lm_dol_yrslost)

```

```{r scat_dol_yrslost}

scat_dol_yrslost <- ggplot(dados, aes(x = yrslost, y = dollars)) +
                                 geom_point() +
                                 geom_smooth(method = "lm") +
                                 scale_x_continuous("Thousands of years of life lost") +
                                 scale_y_continuous("thousands of NIH research dollars") +
                                 theme_minimal() +
  labs(title = paste("Adj R2 = ",signif(summary(lm_dol_yrslost)$adj.r.squared, 5),
                         "Intercept =",signif(lm_dol_yrslost$coef[[1]],5 ),
                         " Slope =",signif(lm_dol_yrslost$coef[[2]], 5),
                         " p =",signif(summary(lm_dol_yrslost)$coef[2,4], 5)))

scat_dol_yrslost


```

```{r lm_dol_disabil}

lm_dol_disabil <- lm(formula = dollars ~ disabil,
                    data = dados)

summary(lm_dol_disabil)

```

```{r scat_dol_disabil}

scat_dol_disabil <- ggplot(dados, aes(x = disabil, y = dollars)) +
                                 geom_point() +
                                 geom_smooth(method = "lm") +
                                 scale_x_continuous("Thousands of disability-adjusted life years") +
                                 scale_y_continuous("thousands of NIH research dollars") +
                                 theme_minimal() +
  labs(title = paste("Adj R2 = ",signif(summary(lm_dol_disabil)$adj.r.squared, 5),
                         "Intercept =",signif(lm_dol_disabil$coef[[1]],5 ),
                         " Slope =",signif(lm_dol_disabil$coef[[2]], 5),
                         " p =",signif(summary(lm_dol_disabil)$coef[2,4], 5)))

scat_dol_disabil

```



__b) Construa manualmente um modelo que você julga que melhor explica o desfecho.__ 

O objetivo do nosso modelo é explicar quais características estão relacionadas com o investimento dado às doenças pelo NIH.
 
As variáveis preditoras candidatas estão relacionadas a: 1) quantidade de pessoas acometidas pela doença, 2) morbidade da doença e 3) mortalidade da doença. 

grupos de preditores:
# quantidade de doentes - preval e incid
# morte causada pela doença - yrslost e mortality
#morbidade causada pela doença - disabil e hospdays


Os 3 aspectos, segundo nossa hipótese, poderiam predizer o desfecho.

No entanto, muitas das variáveis preditoras estão altamente correlacionadas entre si, de modo que não parece apropriado incluir todas no mesmo modelo. Além disso, outro problema que temos é a ausência de certas informações do banco, faltando dados sobre prevalência e incidência para algumas doenças. Assim, o modelo estimado pode não ser válido para elas.

Nosso intuito é estimar o modelo que melhor explique o desfecho contendo um preditor de cada grupo.


Prevalência e incidência não apresentaram alta correlação com nenhum dos outros preditores, mas é possível que isso esteja mascarado pelos dados missing.
As variáveis dos grupos "morte" e "morbidade" de menor correlação são yrslost e disabil.
Modelo 1: yrslost + disabil + preval
Modelo 2: yrslost + disabil + incid

Como sabemos que disabil inclui yrslost, poderíamos comparar yrslost com seu complementar, YLD (disabil - yrslost)

Modelo 3: yrslost + YLD + preval
Modelo 3: yrslost + YLD + incid


```{r manual_mrm_1}

#ficou bem ruim
manual_mrm_1 <- lm(data = dados, formula = (dollars ~ incid + mort + disabil))
  

summary(manual_mrm_1)
```

Percebemos que houve mudanças importantes nos coeficientes do modelo linear multivariável comparado aos modelos lineares simples. As variáveis "mortalidade" e "anos de vida perdidos por morte prematura" passaram a ser estatisticamente significativas no modelo. Esse é mais um indicativo da possível existência de multicolinearidade, da qual já suspeitamos devido à alta correlação entre as variáveis.

Agora faremos, por etapas, a exclusão de variáveis por ordem decrescente do valor p.


```{r manual_mrm_2}

#excluo disabil

manual_mrm_2 <- lm(data = dados, formula = (dollars ~ incid + preval + mort + hospdays+ yrslost))
  

summary(manual_mrm_2)
```

```{r manual_mrm_3}

#excluo incid

manual_mrm_3 <- lm(data = dados, formula = (dollars ~ preval + mort + hospdays+ yrslost))
  

summary(manual_mrm_3)
```

```{r manual_mrm_4}

# excluo preval

manual_mrm_4 <- lm(data = dados, formula = (dollars ~ mort + hospdays+ yrslost))
  

summary(manual_mrm_4)
```




Podemos tirar isso abaixo, na minha opinião:

```{r scatter_yrslost_mort}

ggplot(dados, aes(x = yrslost, y = mort)) +
                                 geom_point() +
                                 scale_x_continuous("Thousands of years of life lost") +
                                 scale_y_continuous("Mortality per 1000") +
                                 theme_minimal()


```

```{r scatter_yrslost_DALY}

ggplot(dados, aes(x = yrslost, y = disabil)) +
                                 geom_point() +
                                 scale_x_continuous("Thousands of years of life lost") +
                                 scale_y_continuous("Thousands of disability-adjusted life years") +
                                 theme_minimal()


```


__c) Faça o gráfico dos valores preditos versus os resíduos studentizados. Interprete os resultados.__



2. 

__a. Transforme todas as variáveis utilizadas na questão 1 em logaritmo natural.Utilize o método stepwise para selecionar os preditores.__


```{r stepwise_mrm_1}

#começo pelo preditor de maior significância estatística, yrslost

stepwise_mrm_1 <- lm(data = dados, formula = (dollars ~ log(yrslost)))
  

summary(stepwise_mrm_1)
```

```{r stepwise_mrm_2}

#adiciono disabil

stepwise_mrm_2 <- lm(data = dados, formula = (dollars ~ log(yrslost) + log(disabil)))
  

summary(stepwise_mrm_2)
```

```{r stepwise_mrm_3}

#troco disabil por incid

stepwise_mrm_3 <- lm(data = dados, formula = (dollars ~ log(yrslost) + log(incid)))
  

summary(stepwise_mrm_3)
```

```{r stepwise_mrm_4}

#mort

stepwise_mrm_4 <- lm(data = dados, formula = (dollars ~ log(yrslost) + log(mort)))
  

summary(stepwise_mrm_4)
```

```{r stepwise_mrm_5}

#hospdays

stepwise_mrm_5 <- lm(data = dados, formula = (dollars ~ log(yrslost) + log(hospdays)))
  

summary(stepwise_mrm_5)
```

```{r stepwise_mrm_6}

#preval
#mantenho esse, por dar a maior explicação ao desfecho

stepwise_mrm_6 <- lm(data = dados, formula = (dollars ~ log(yrslost) + log(preval)))
  

summary(stepwise_mrm_6)
```

```{r stepwise_mrm_7}

#incluir segunda melhor explicativa, hospdays

stepwise_mrm_7 <- lm(data = dados, formula = (dollars ~ log(yrslost) + log(preval) + log(hospdays)))
  

summary(stepwise_mrm_7)
```


__b. Faça um resumo dos passos que o algoritmo tomou.__

O modelo foi iniciado pelo preditor de maior significância estatística, yrslost. Em seguida, foi testada a explicação do desfecho em modelo com esse preditor e cada um dos outros, escolhendo o de maior R2 ajustado (yrslost + preval). Como permaneceram no modelo um preditor da categoria "morte" e outro da categoria "proporção de casos na população", resta apenas um que indique "morbidade". 


__c. Faça o gráfico dos valores preditos versus os resíduos studentizados para o modelo final.__




__d. Compare com a resposta da questão 1.__

O modelo transformando as variáveis com log apresenta maior explicação do desfecho que o modelo sem transformação, como pode ser visto abaixo.

```{r stepwise_semlog}

#o certo seria comparar com o nosso modelo 

sem_log <- lm(data = dados, formula = (dollars ~ yrslost + preval + hospdays))
  

summary(sem_log)
```

3. Para o modelo final da questão 2, faça o diagnóstico completo avaliando as suposições sobre os resíduos, multicolinearidade e observações influentes. Interprete os resultados.






__4. Faça a regressão entre log(dollars) versus log(disabil) e log(hospdays). Interprete os resultados.__

```{r mrm_log}

mrm_log <- lm(data = dados, formula = (log(dollars) ~ log(disabil) + log(hospdays)))
  

summary(mrm_log)
```




5. Utilizando o modelo da questão 4, qual é a estimativa da quantidade média de fundos de pesquisa orçados para doenças que causam 1 milhão de dias de hospitalização em um ano e a perda de 1 milhão de anos de vida ajustados por incapacidade? Calcule o intervalo de 95% de confiança para este valor. Também calcule o IC 95% para um financiamento que seria fornecido a uma nova doença que causa 1 milhão de dias de hospitalização em um ano e a perda de 1 milhão de anos de vida ajustados por incapacidade.

6. Crie uma variável dummy que assume valor 1 se hospdays >= 1000 e 0 caso contrário. Faça a regressão entre log(dollars) versus log(disabil) e a variável dummy. Interprete os resultados, escrevendo as equações para cada categoria da variável dummy. Teste se é necessário incluir uma interação no modelo.



