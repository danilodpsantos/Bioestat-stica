---
title: "Trabalho 1 Modelos Lineares"
author: "Danilo de Paula Santos"
date: "10/18/2019"
output:
  html_document:
    df_print: paged
---

As questões a seguir referem-se ao estudo de Gross et al (1999) sobre a relação entre financiamento pelo National Institutes of Health e carga de 29 doenças. Os dados da Tabela 1 desde estudo estão no arquivo 3.ex.Funding.sav. Os nomes das variáveis e definições neste arquivo são:

!["variaveis"](C:/Users/Gabriela/Documents/Bioestatistica_PPGEPI/Modelos_lineares/Trabalho_1/variaveis_gross.PNG)


```{r preparing_R}

# install.packages("haven")
# install.packages("ggplot2")

library("haven")
library("ggplot2")
library("compareGroups")
library("tidyverse")

dados <- read_spss(file = "3.ex.Funding.sav")

```
# DESCRIÇÃO GERAL DO BANCO

```{r agrupando_diseases}
# transformando disease e factor
dados$disease <- factor(dados$disease)


# Gerando grupos de doenças

dados$disease_group <- ifelse(dados$disease ==  "Breast Cancer"     |
                              dados$disease ==  "Cervical cancer"   |
                              dados$disease ==  "Colorectal cancer" |
                              dados$disease ==  "Lung cancer"     |
                              dados$disease ==  "Ovarian cancer"  |
                              dados$disease ==  "Prostate cancer" |
                              dados$disease ==  "Uterine cancer", "Cancer", 
                              ifelse( dados$disease == "Cirrhosis" |
                                      dados$disease == "Chronic obst. pulmonary d" |
                                      dados$disease == "Ischemic heart disease" |
                                      dados$disease == "Stroke"  |
                                      dados$disease ==  "Diabetes mellitus"|
                                      dados$disease ==   "Asthma" | 
                                      dados$disease == "Peptic ulcer"|
                                      dados$disease == "Alcohol abuse","Non-communicable diseases",
                                      ifelse(dados$disease == "Dental and oral disorders","Other non-communicable diseases",
                                      ifelse(dados$disease == "Dementia" |
                                             dados$disease == "Depression"  |
                                             dados$disease == "Epilepsy"   |
                                             dados$disease == "Parkinson's disease" | 
                                             dados$disease ==  "Multiple sclerosis" |
                                             dados$disease == "Schizophrenia" , "Mental and neurological disorders", 
                                             ifelse(dados$disease == "Tuberculosis"|
                                                    dados$disease == "Sexually transmitted dise"|
                                                    dados$disease == "Pneumonia" |
                                                    dados$disease == "Otitis media"|
                                                    dados$disease == "Perinatal conditions", "Communicable and neonatal diseases",
                                                           ifelse(dados$disease == "Injuries", "Injuries", 
                                                                  ifelse(dados$disease == "AIDS", "AIDS", NA)))))))


```

```{r variaveis_grupos}

dados_grupo <- dados%>%
  group_by(disease_group) %>%
  summarise(dollars_group = sum(dollars, na.rm = TRUE),
            incid_group = sum(incid, na.rm = TRUE),
            preval_group = sum(preval, na.rm = TRUE),
            hospdays_group = sum(hospdays, na.rm = TRUE),
            mort_group = sum(mort, na.rm = TRUE),
            yrslost_group = sum(yrslost, na.rm = TRUE),
            disabil_group = sum(disabil, na.rm = TRUE))

dados <- merge(dados, dados_grupo)

```

```{r descritiva_ex_1 }

compare_doencas <- compareGroups(disease_group ~ dollars_group + incid_group + preval_group + hospdays_group + mort_group + yrslost_group + disabil_group,
                                 data = dados,
                                 max.ylev = 29)

table_descr <- createTable(compare_doencas, show.p.overall = FALSE, show.ratio = TRUE, show.n = FALSE, type = 3)


table_descr
```

1. 

__a) Explore a relação entre dollars e as outras variáveis independentes (exceto disease e id).__ 

```{r correlation_var_outcome}

#Crio um objeto com as variáveis que quero correlacionar
my_data <- dados[,c("dollars", "incid", "preval", "mort", "hospdays", "yrslost", "disabil")]

#aplico a função de correlação, ignorando os valores missing (complete.obs)
cor_matrix <- cor(my_data, use = "complete.obs")

#arredondo para duas casas decimais
round(cor_matrix,2)
```

```{r correlation_plot}

#Não sei se ficou bom
pairs( ~ dollars+incid+preval+ mort+ hospdays+ yrslost+ disabil, data = dados)
```


```{r scat_function}

#Função que fixa o banco como dados e o y como dólares para criar um scatterplot


dollar_plot <- function(data, x_var, y_var ){
  
  

  ggplot(data = data,
         aes(x = x_var,
             y = y_var)) +
    geom_point()
  
  
}


```


```{r lm_dol_incid}

lm_dol_incid <- lm(formula = dollars ~ incid,
                    data = dados)

summary(lm_dol_incid)


```

```{r scat_dol_incid}




scat_dol_incid <- ggplot(dados, aes(x = incid, y = dollars)) +
                                 geom_point() +
                                 geom_smooth(method = "lm") +
                                 scale_x_continuous("Incidence per 1000") +
                                 scale_y_continuous("thousands of NIH research dollars") +
                                 theme_minimal() +
  labs(title = paste("Adj R2 = ",signif(summary(lm_dol_incid)$adj.r.squared, 5),
                         "Intercept =",signif(lm_dol_incid$coef[[1]],5 ),
                         " Slope =",signif(lm_dol_incid$coef[[2]], 5),
                         " p =",signif(summary(lm_dol_incid)$coef[2,4], 5)))

scat_dol_incid
```


```{r lm_dol_preval}

lm_dol_preval <- lm(formula = dollars ~ preval,
                    data = dados)

summary(lm_dol_preval)


```

```{r scat_dol_preval}

scat_dol_preval <- ggplot(dados, aes(x = incid, y = dollars)) +
                                 geom_point() +
                                 geom_smooth(method = "lm") +
                                 scale_x_continuous("Incidence per 1000") +
                                 scale_y_continuous("thousands of NIH research dollars") +
                                 theme_minimal() +
  labs(title = paste("Adj R2 = ",signif(summary(lm_dol_preval)$adj.r.squared, 5),
                         "Intercept =",signif(lm_dol_preval$coef[[1]],5 ),
                         " Slope =",signif(lm_dol_preval$coef[[2]], 5),
                         " p =",signif(summary(lm_dol_preval)$coef[2,4], 5)))

scat_dol_preval


```

```{r lm_dol_mort}

lm_dol_mort <- lm(formula = dollars ~ mort,
                    data = dados)

summary(lm_dol_mort)


```

```{r scat_dol_mort}

scat_dol_mort <- ggplot(dados, aes(x = mort, y = dollars)) +
                                 geom_point() +
                                 geom_smooth(method = "lm") +
                                 scale_x_continuous("Mortality per 1000") +
                                 scale_y_continuous("thousands of NIH research dollars") +
                                 theme_minimal() +
  labs(title = paste("Adj R2 = ",signif(summary(lm_dol_mort)$adj.r.squared, 5),
                         "Intercept =",signif(lm_dol_mort$coef[[1]],5 ),
                         " Slope =",signif(lm_dol_mort$coef[[2]], 5),
                         " p =",signif(summary(lm_dol_mort)$coef[2,4], 5)))

scat_dol_mort


```

```{r lm_dol_hospdays}

lm_dol_hospdays <- lm(formula = dollars ~ hospdays,
                    data = dados)

summary(lm_dol_hospdays)


```

```{r scat_dol_hospdays}

scat_dol_hospdays <- ggplot(dados, aes(x = hospdays, y = dollars)) +
                                 geom_point() +
                                 geom_smooth(method = "lm") +
                                 scale_x_continuous("Thousands of hospital days") +
                                 scale_y_continuous("thousands of NIH research dollars") +
                                 theme_minimal() +
  labs(title = paste("Adj R2 = ",signif(summary(lm_dol_hospdays)$adj.r.squared, 5),
                         "Intercept =",signif(lm_dol_hospdays$coef[[1]],5 ),
                         " Slope =",signif(lm_dol_hospdays$coef[[2]], 5),
                         " p =",signif(summary(lm_dol_hospdays)$coef[2,4], 5)))

scat_dol_hospdays


```
```{r lm_dol_yrslost}

lm_dol_yrslost <- lm(formula = dollars ~ yrslost,
                    data = dados)

summary(lm_dol_yrslost)

```

```{r scat_dol_yrslost}

scat_dol_yrslost <- ggplot(dados, aes(x = yrslost, y = dollars)) +
                                 geom_point() +
                                 geom_smooth(method = "lm") +
                                 scale_x_continuous("Thousands of years of life lost") +
                                 scale_y_continuous("thousands of NIH research dollars") +
                                 theme_minimal() +
  labs(title = paste("Adj R2 = ",signif(summary(lm_dol_yrslost)$adj.r.squared, 5),
                         "Intercept =",signif(lm_dol_yrslost$coef[[1]],5 ),
                         " Slope =",signif(lm_dol_yrslost$coef[[2]], 5),
                         " p =",signif(summary(lm_dol_yrslost)$coef[2,4], 5)))

scat_dol_yrslost


```

```{r lm_dol_disabil}

lm_dol_disabil <- lm(formula = dollars ~ disabil,
                    data = dados)

summary(lm_dol_disabil)

```

```{r scat_dol_disabil}

scat_dol_disabil <- ggplot(dados, aes(x = disabil, y = dollars)) +
                                 geom_point() +
                                 geom_smooth(method = "lm") +
                                 scale_x_continuous("Thousands of disability-adjusted life years") +
                                 scale_y_continuous("thousands of NIH research dollars") +
                                 theme_minimal() +
  labs(title = paste("Adj R2 = ",signif(summary(lm_dol_disabil)$adj.r.squared, 5),
                         "Intercept =",signif(lm_dol_disabil$coef[[1]],5 ),
                         " Slope =",signif(lm_dol_disabil$coef[[2]], 5),
                         " p =",signif(summary(lm_dol_disabil)$coef[2,4], 5)))

scat_dol_disabil

```



__b) Construa manualmente um modelo que você julga que melhor explica o desfecho.__ 

Acreditamos que investimento em pesquisa do NIH pode ser explicado pela quantidade de pessoas acometidas pela doença e sua morbidade e mortalidade. Todas as variáveis preditoras estão relacionadas a isso. No entanto, como vimos no passo anterior, muitas das variáveis preditoras estão altamente correlacionadas entre si, de modo que não parece apropriado incluir todas no mesmo modelo. 

Dado que, isoladamente, nenhuma das variáveis preditoras está significativamente associada ao desfecho, fica difícil a decisão de quais delas excluir. Começamos excluindo "incidência em 1990", pois entendemos que está incluída na variável "prevalência em 1990". Além disso a variável de prevalência está mais correlacionada com o desfecho.


```{r mr_dol_1}

mr_dol_1 <- lm(data = dados, formula = (dollars ~ preval + mort + hospdays+ yrslost + disabil))
  

summary(mr_dol_1)
```

Percebemos que houve mudanças importantes nos coeficientes do modelo linear multivariável comparado aos modelos lineares simples. As variáveis "mortalidade" e "anos de vida perdidos por morte prematura" passaram a ser estatisticamente significativas no modelo. Esse é mais um indicativo da possível existência de multicolinearidade, da qual já suspeitamos devido à alta correlação entre as variáveis.


```{r scatter_yrslost_mort}

ggplot(dados, aes(x = yrslost, y = mort)) +
                                 geom_point() +
                                 scale_x_continuous("Thousands of years of life lost") +
                                 scale_y_continuous("Mortality per 1000") +
                                 theme_minimal()


```

```{r scatter_yrslost_DALY}

ggplot(dados, aes(x = yrslost, y = disabil)) +
                                 geom_point() +
                                 scale_x_continuous("Thousands of years of life lost") +
                                 scale_y_continuous("Thousands of disability-adjusted life years") +
                                 theme_minimal()


```


__c) Faça o gráfico dos valores preditos versus os resíduos studentizados. Interprete os resultados.__







2. Transforme todas as variáveis utilizadas na questão 1 em logaritmo natural. Utilize o método stepwise para selecionar os preditores. Faça um resumo dos passos que o algoritmo tomou. Faça o gráfico dos valores preditos versus os resíduos studentizados para o modelo final. Compare com a resposta da questão 1.
3. Para o modelo final da questão 2, faça o diagnóstico completo avaliando as suposições sobre os resíduos, multicolinearidade e observações influentes. Interprete os resultados.